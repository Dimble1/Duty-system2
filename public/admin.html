<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ê–¥–º–∏–Ω ‚Äî –°–∏—Å—Ç–µ–º–∞ –¥–µ–∂—É—Ä—Å—Ç–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <h1 class="text-3xl font-bold text-center text-red-700 mb-6">‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏ -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-2xl font-bold text-red-600 mb-4">üë©‚Äçüéì –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏</h2>
    <form id="addStudentForm" class="flex gap-2 mb-4">
      <input type="text" id="studentName" placeholder="–ò–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞" class="border p-2 flex-1 rounded" />
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
    <ul id="student-list" class="space-y-2"></ul>
  </div>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-2xl font-bold text-indigo-600 mb-4">üìÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h2>
    <form id="editRosterForm" class="flex gap-2 mb-4">
      <input type="date" id="rosterDate" class="border p-2 rounded" />
      <input type="text" id="rosterNames" placeholder="–ò–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" class="border p-2 flex-1 rounded" />
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
    <ul id="roster-list" class="space-y-2"></ul>
  </div>

  <!-- –ó–∞–º–µ–Ω–∞ -->
  <div class="bg-white rounded-xl shadow-lg p-6">
    <h2 class="text-2xl font-bold text-purple-600 mb-4">üîÑ –ó–∞–º–µ–Ω–∞</h2>
    <form id="replaceForm" class="flex gap-2 mb-4">
      <input type="date" id="replaceDate" class="border p-2 rounded" />
      <select id="replaceFrom" class="border p-2 rounded"></select>
      <select id="replaceTo" class="border p-2 rounded"></select>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">üîÑ –ó–∞–º–µ–Ω–∏—Ç—å</button>
    </form>
  </div>

  <script>
    let studentsCache = [];

    async function getJSON(url, opts = {}) {
      const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'ts=' + Date.now(), opts);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    async function getStudents() { return getJSON('/api/students'); }
    async function addStudent(name) {
      return getJSON('/api/students', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ name })
      });
    }
    async function updateStudent(name, status, role) {
      return getJSON('/api/students', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ name, status, role })
      });
    }
    async function deleteStudent(name) {
      return getJSON('/api/students', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ name })
      });
    }

    async function getRoster() { return getJSON('/api/roster'); }
    async function saveRoster(date, names) {
      return getJSON('/api/roster', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ date, names })
      });
    }

    function renderStudents(students) {
      studentsCache = students;
      const list = document.getElementById('student-list');
      list.innerHTML = '';
      students.forEach(s => {
        const li = document.createElement('li');
        li.className = 'bg-red-50 border-l-4 border-red-400 p-3 rounded flex justify-between items-center gap-2';
        const left = document.createElement('span');
        left.innerHTML = `<b>${s.name}</b> ‚Äî ${s.status} (${s.role})`;
        const actions = document.createElement('div');
        actions.className = 'flex flex-wrap gap-2';
        const btnActive = mkBtn('–ê–∫—Ç–∏–≤', 'bg-blue-600', async () => { await updateStudent(s.name, '–ê–∫—Ç–∏–≤–µ–Ω', 'student'); await loadData(); });
        const btnZam = mkBtn('–ó–∞–º', 'bg-purple-600', async () => { await updateStudent(s.name, '–ê–∫—Ç–∏–≤–µ–Ω', 'zam'); await loadData(); });
        const btnStarosta = mkBtn('–°—Ç–∞—Ä–æ—Å—Ç–∞', 'bg-pink-600', async () => { await updateStudent(s.name, '–ê–∫—Ç–∏–≤–µ–Ω', 'starosta'); await loadData(); });
        const btnRunaway = mkBtn('–°–±–µ–∂–∞–ª', 'bg-yellow-600', async () => { await updateStudent(s.name, '–°–±–µ–∂–∞–ª', s.role); await loadData(); });
        const btnRemoveRole = mkBtn('–£–±—Ä–∞—Ç—å —Ä–æ–ª—å', 'bg-gray-600', async () => { await updateStudent(s.name, s.status, 'student'); await loadData(); });
        const btnDelete = mkBtn('‚ùå –£–¥–∞–ª–∏—Ç—å', 'bg-red-600', async () => { await deleteStudent(s.name); await loadData(); });
        actions.append(btnActive, btnZam, btnStarosta, btnRunaway, btnRemoveRole, btnDelete);
        li.append(left, actions);
        list.appendChild(li);
      });
    }

    function mkBtn(text, color, handler) {
      const btn = document.createElement('button');
      btn.className = `${color} text-white px-2 py-1 rounded`;
      btn.textContent = text;
      btn.addEventListener('click', handler);
      return btn;
    }

    function renderRoster(roster) {
      const list = document.getElementById('roster-list');
      list.innerHTML = '';
      Object.keys(roster).forEach(date => {
        const li = document.createElement('li');
        li.className = 'bg-indigo-50 border-l-4 border-indigo-400 p-3 rounded';
        const names = roster[date].map(n => n.includes('–°–±–µ–∂–∞–ª') ? `${n} ‚ùå` : n);
        li.textContent = `${date}: ${names.join(', ')}`;
        list.appendChild(li);
      });
      populateReplaceOptions(roster);
    }

    function populateReplaceOptions(roster) {
      const date = document.getElementById('replaceDate').value;
      const fromSelect = document.getElementById('replaceFrom');
      const toSelect = document.getElementById('replaceTo');
      fromSelect.innerHTML = '';
      toSelect.innerHTML = '';
      if (date && roster[date]) {
        roster[date].forEach(n => {
          const opt = document.createElement('option');
          opt.value = n;
          opt.textContent = n;
          fromSelect.appendChild(opt);
        });
      }
      studentsCache.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.name;
        opt.textContent = s.name;
        toSelect.appendChild(opt);
      });
    }

    document.getElementById('addStudentForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('studentName').value.trim();
      if (!name) return;
      await addStudent(name);
      document.getElementById('studentName').value = '';
      await loadData();
    });

    document.getElementById('editRosterForm').addEventListener('submit', async e => {
      e.preventDefault();
      const date = document.getElementById('rosterDate').value;
      const names = document.getElementById('rosterNames').value.split(',').map(n => n.trim()).filter(Boolean);
      await saveRoster(date, names);
      document.getElementById('rosterNames').value = '';
      await loadData();
    });

        document.getElementById('replaceDate').addEventListener('change', async () => {
      const roster = await getRoster();
      populateReplaceOptions(roster);
    });

    document.getElementById('replaceForm').addEventListener('submit', async e => {
      e.preventDefault();
      const from = document.getElementById('replaceFrom').value;
      const to = document.getElementById('replaceTo').value;
      const date = document.getElementById('replaceDate').value;
      if (!from || !to || !date) return;
      const roster = await getRoster();
      if (roster[date]) {
        roster[date] = roster[date].map(n => n === from ? to : n);
        await saveRoster(date, roster[date]);
        await loadData();
      }
    });

    async function loadData() {
      try {
        const students = await getStudents();
        renderStudents(students);
        const roster = await getRoster();
        renderRoster(roster);
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err);
      }
    }

    loadData();
  </script>
</body>
</html>















      
      populateReplaceOptions(roster
