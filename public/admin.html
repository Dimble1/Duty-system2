<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>ĞĞ´Ğ¼Ğ¸Ğ½ â€” Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ´ĞµĞ¶ÑƒÑ€ÑÑ‚Ğ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <h1 class="text-3xl font-bold text-center text-red-700 mb-6">âš™ï¸ ĞŸĞ°Ğ½ĞµĞ»ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°</h1>

  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-2xl font-bold text-red-600 mb-4">ğŸ‘©â€ğŸ“ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸</h2>
    <form id="addStudentForm" class="flex gap-2 mb-4">
      <input type="text" id="studentName" placeholder="Ğ˜Ğ¼Ñ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°" class="border p-2 flex-1 rounded" />
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
    </form>
    <ul id="student-list" class="space-y-2"></ul>
  </div>

  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-2xl font-bold text-indigo-600 mb-4">ğŸ“… Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ</h2>
    <form id="editRosterForm" class="flex gap-2 mb-4">
      <input type="date" id="rosterDate" class="border p-2 rounded" />
      <input type="text" id="rosterNames" placeholder="Ğ˜Ğ¼ĞµĞ½Ğ° Ñ‡ĞµÑ€ĞµĞ· Ğ·Ğ°Ğ¿ÑÑ‚ÑƒÑ" class="border p-2 flex-1 rounded" />
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
    </form>
    <ul id="roster-list" class="space-y-2"></ul>
  </div>

  <div class="bg-white rounded-xl shadow-lg p-6">
    <h2 class="text-2xl font-bold text-purple-600 mb-4">ğŸ”„ Ğ—Ğ°Ğ¼ĞµĞ½Ğ°</h2>
    <form id="replaceForm" class="flex gap-2 mb-4">
      <input type="text" id="replaceFrom" placeholder="ĞšĞ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ" class="border p-2 rounded" />
      <input type="text" id="replaceTo" placeholder="ĞĞ° ĞºĞ¾Ğ³Ğ¾" class="border p-2 rounded" />
      <input type="date" id="replaceDate" class="border p-2 rounded" />
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">ğŸ”„ Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</button>
    </form>
  </div>

  <script>
    async function getJSON(url, opts = {}) {
      const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'ts=' + Date.now(), opts);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    async function getStudents() { return getJSON('/api/students'); }
    async function addStudent(name) {
      return getJSON('/api/students', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ name })
      });
    }
    async function updateStudent(name, status, role) {
      return getJSON('/api/students', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ name, status, role })
      });
    }
    async function deleteStudent(name) {
      return getJSON('/api/students', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ name })
      });
    }

    async function getRoster() { return getJSON('/api/roster'); }
    async function saveRoster(date, names) {
      return getJSON('/api/roster', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ date, names })
      });
    }

    function renderStudents(students) {
      const list = document.getElementById('student-list');
      list.innerHTML = '';
      students.forEach(s => {
        const li = document.createElement('li');
        li.className = 'bg-red-50 border-l-4 border-red-400 p-3 rounded flex justify-between items-center gap-2';
        const left = document.createElement('span');
        left.innerHTML = `<b>${s.name}</b> â€” ${s.status} (${s.role})`;
        const actions = document.createElement('div');
        actions.className = 'flex flex-wrap gap-2';
        const btnActive = mkBtn('ĞĞºÑ‚Ğ¸Ğ²', 'bg-blue-600', async () => { await updateStudent(s.name, 'ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½', 'student'); await loadData(); });
        const btnZam = mkBtn('Ğ—Ğ°Ğ¼', 'bg-purple-600', async () => { await updateStudent(s.name, 'ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½', 'zam'); await loadData(); });
        const btnStarosta = mkBtn('Ğ¡Ñ‚Ğ°Ñ€Ğ¾ÑÑ‚Ğ°', 'bg-pink-600', async () => { await updateStudent(s.name, 'ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½', 'starosta'); await loadData(); });
        const btnRunaway = mkBtn('Ğ¡Ğ±ĞµĞ¶Ğ°Ğ»', 'bg-yellow-600', async () => { await updateStudent(s.name, 'Ğ¡Ğ±ĞµĞ¶Ğ°Ğ»', s.role); await loadData(); });
        const btnDelete = mkBtn('âŒ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ', 'bg-red-600', async () => { await deleteStudent(s.name); await loadData(); });
        actions.append(btnActive, btnZam, btnStarosta, btnRunaway, btnDelete);
        li.append(left, actions);
        list.appendChild(li);
      });
    }

    function mkBtn(text, color, handler) {
      const btn = document.createElement('button');
      btn.className = `${color} text-white px-2 py-1 rounded`;
      btn.textContent = text;
      btn.addEventListener('click', handler);
      return btn;
    }

    function renderRoster(roster) {
      const list = document.getElementById('roster-list');
      list.innerHTML = '';
      Object.keys(roster).forEach(date => {
        const li = document.createElement('li');
        li.className = 'bg-indigo-50 border-l-4 border-indigo-400 p-3 rounded';
        const names = roster[date].map(n => n.includes('Ğ¡Ğ±ĞµĞ¶Ğ°Ğ»') ? `${n} âŒ` : n);
        li.textContent = `${date}: ${names.join(', ')}`;
        list.appendChild(li);
      });
    }

    document.getElementById('addStudentForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('studentName').value.trim();
      if (!name) return;
      await addStudent(name);
      document.getElementById('studentName').value = '';
      await loadData();
    });

    document.getElementById('editRosterForm').addEventListener('submit', async e => {
      e.preventDefault();
      const date = document.getElementById('rosterDate').value;
      const names = document.getElementById('rosterNames').value.split(',').map(n => n.trim()).filter(Boolean);
      await saveRoster(date, names);
      document.getElementById('rosterNames').value = '';
      await loadData();
    });

    document.getElementById('replaceForm').addEventListener('submit', async e => {
      e.preventDefault();
      const from = document.getElementById('replaceFrom').value.trim();
      const to = document.getElementById('replaceTo').value.trim();
      const date = document.getElementById('replaceDate').value;
      if (!from || !to || !date) return;
      const roster = await getRoster();
      if (roster[date]) {
        roster[date] = roster[date].map(n => n === from ? to : n);
        await saveRoster(date, roster[date]);
        await loadData();
      }
    });

    async function loadData() {
      const students = await getStudents();
      renderStudents(students);
      const roster = await getRoster();
      renderRoster(roster);
    }

    loadData();
  </script>
</body>
</html>
