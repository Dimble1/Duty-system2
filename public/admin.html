<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ê–¥–º–∏–Ω ‚Äî –°–∏—Å—Ç–µ–º–∞ –¥–µ–∂—É—Ä—Å—Ç–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <h1 class="text-3xl font-bold text-center text-red-700 mb-6">‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏ -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-2xl font-bold text-red-600 mb-4">üë©‚Äçüéì –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏</h2>

    <!-- –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
    <form id="addStudentForm" class="flex gap-2 mb-4">
      <input type="text" id="studentName" placeholder="–ò–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞" class="border p-2 flex-1 rounded" />
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </form>

    <!-- –°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
    <ul id="student-list" class="space-y-2"></ul>
  </div>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º -->
  <div class="bg-white rounded-xl shadow-lg p-6">
    <h2 class="text-2xl font-bold text-indigo-600 mb-4">üìÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h2>
    <form id="editRosterForm" class="flex gap-2 mb-4">
      <input type="date" id="rosterDate" class="border p-2 rounded" />
      <input type="text" id="rosterNames" placeholder="–ò–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" class="border p-2 flex-1 rounded" />
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
    <ul id="roster-list" class="space-y-2"></ul>
  </div>

  <script>
    // --- –†–∞–±–æ—Ç–∞ —Å API ---
    async function getJSON(url, opts = {}) {
      const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'ts=' + Date.now(), opts);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    async function getStudents() {
      return getJSON('/api/students');
    }

    async function addStudent(name) {
      return getJSON('/api/students', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ name })
      });
    }

    async function updateStudent(name, status, role) {
      return getJSON('/api/students', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ name, status, role })
      });
    }

    async function deleteStudent(name) {
      return getJSON('/api/students', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ name })
      });
    }

    async function getRoster() {
      return getJSON('/api/roster');
    }

    async function saveRoster(date, names) {
      return getJSON('/api/roster', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ date, names })
      });
    }

    // --- –†–µ–Ω–¥–µ—Ä —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (–±–µ–∑ inline onclick) ---
    function renderStudents(students) {
      const list = document.getElementById('student-list');
      list.innerHTML = '';
      students.forEach(s => {
        const li = document.createElement('li');
        li.className = 'bg-red-50 border-l-4 border-red-400 p-3 rounded flex justify-between items-center gap-2';

        const left = document.createElement('span');
        left.innerHTML = `<b>${s.name}</b> ‚Äî ${s.status} (${s.role})`;

        const actions = document.createElement('div');
        actions.className = 'flex flex-wrap gap-2';

        const btnActive = document.createElement('button');
        btnActive.className = 'bg-blue-600 text-white px-2 py-1 rounded';
        btnActive.textContent = '–ê–∫—Ç–∏–≤';
        btnActive.addEventListener('click', async () => {
          await updateStudent(s.name, '–ê–∫—Ç–∏–≤–µ–Ω', 'student');
          await loadData();
        });

        const btnInactive = document.createElement('button');
        btnInactive.className = 'bg-yellow-600 text-white px-2 py-1 rounded';
        btnInactive.textContent = '–ù–µ–∞–∫—Ç–∏–≤';
        btnInactive.addEventListener('click', async () => {
          await updateStudent(s.name, '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω', 'student');
          await loadData();
        });

        const btnZam = document.createElement('button');
        btnZam.className = 'bg-purple-600 text-white px-2 py-1 rounded';
        btnZam.textContent = '–ó–∞–º';
        btnZam.addEventListener('click', async () => {
          await updateStudent(s.name, '–ê–∫—Ç–∏–≤–µ–Ω', 'zam');
          await loadData();
        });

        const btnDelete = document.createElement('button');
        btnDelete.className = 'bg-red-600 text-white px-2 py-1 rounded';
        btnDelete.textContent = '‚ùå –£–¥–∞–ª–∏—Ç—å';
        btnDelete.addEventListener('click', async () => {
          await deleteStudent(s.name);
          await loadData();
        });

        actions.append(btnActive, btnInactive, btnZam, btnDelete);
        li.append(left, actions);
        list.appendChild(li);
      });
    }

    // --- –†–µ–Ω–¥–µ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è ---
    function renderRoster(roster) {
      const list = document.getElementById('roster-list');
      list.innerHTML = '';
      Object.keys(roster).forEach(date => {
        const li = document.createElement('li');
        li.className = 'bg-indigo-50 border-l-4 border-indigo-400 p-3 rounded';
        li.textContent = `${date}: ${roster[date].join(', ')}`;
        list.appendChild(li);
      });
    }

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º ---
    document.getElementById('addStudentForm').addEventListener('submit', async e => {
      e.preventDefault();
      const nameEl = document.getElementById('studentName');
      const name = nameEl.value.trim();
      if (!name) return;
      try {
        await addStudent(name);
        nameEl.value = '';
        await loadData();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ' + err.message);
      }
    });

    document.getElementById('editRosterForm').addEventListener('submit', async e => {
      e.preventDefault();
      const date = document.getElementById('rosterDate').value;
      const raw = document.getElementById('rosterNames').value;
      const names = raw.split(',').map(n => n.trim()).filter(Boolean);
      if (!date || names.length === 0) return;
      try {
        await saveRoster(date, names);
        document.getElementById('rosterNames').value = '';
        await loadData();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: ' + err.message);
      }
    });

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö + –∞–Ω—Ç–∏-–∫—ç—à ---
    async function loadData() {
      try {
        const students = await getStudents();
        renderStudents(students);
      } catch (err) {
        console.error('students load error', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤');
      }

      try {
        const roster = await getRoster();
        renderRoster(roster);
      } catch (err) {
        console.error('roster load error', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ');
      }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadData();
  </script>
</body>
</html>
