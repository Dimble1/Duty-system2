<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω ‚Äî –°–∏—Å—Ç–µ–º–∞ –¥–µ–∂—É—Ä—Å—Ç–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <h1 class="text-3xl font-bold text-center text-red-700 mb-6">‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏ -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-2xl font-bold text-red-600 mb-4">üë©‚Äçüéì –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏</h2>

    <!-- –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
    <form id="addStudentForm" class="flex gap-2 mb-4">
      <input type="text" id="studentName" placeholder="–ò–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞" class="border p-2 flex-1 rounded"/>
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </form>

    <!-- –°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
    <ul id="student-list" class="space-y-2"></ul>
  </div>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º -->
  <div class="bg-white rounded-xl shadow-lg p-6">
    <h2 class="text-2xl font-bold text-indigo-600 mb-4">üìÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h2>
    <form id="editRosterForm" class="flex gap-2 mb-4">
      <input type="date" id="rosterDate" class="border p-2 rounded"/>
      <input type="text" id="rosterNames" placeholder="–ò–º–µ–Ω–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" class="border p-2 flex-1 rounded"/>
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
    <ul id="roster-list" class="space-y-2"></ul>
  </div>

  <script type="module">
    // --- API –∑–∞–ø—Ä–æ—Å—ã ---
    async function getStudents() {
      const res = await fetch('/api/students?ts=' + Date.now());
      return await res.json();
    }

    async function addStudent(name) {
      await fetch('/api/students', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ name })
      });
    }

    async function updateStudent(name, status, role) {
      await fetch('/api/students', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ name, status, role })
      });
    }

    async function deleteStudent(name) {
      await fetch('/api/students', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ name })
      });
    }

    async function getRoster() {
      const res = await fetch('/api/roster?ts=' + Date.now());
      return await res.json();
    }

    async function saveRoster(date, names) {
      await fetch('/api/roster', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
        body: JSON.stringify({ date, names })
      });
    }

    // --- –†–µ–Ω–¥–µ—Ä —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ ---
    function renderStudents(students) {
      const list = document.getElementById('student-list');
      list.innerHTML = '';
      students.forEach(s => {
        const li = document.createElement('li');
        li.className = "bg-red-50 border-l-4 border-red-400 p-3 rounded flex justify-between items-center";
        li.innerHTML = `
          <span><b>${s.name}</b> ‚Äî ${s.status} (${s.role})</span>
          <div class="flex gap-2">
            <button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="updateStudent('${s.name}','–ê–∫—Ç–∏–≤–µ–Ω','student').then(loadData)">–ê–∫—Ç–∏–≤</button>
            <button class="bg-yellow-600 text-white px-2 py-1 rounded" onclick="updateStudent('${s.name}','–ù–µ–∞–∫—Ç–∏–≤–µ–Ω','student').then(loadData)">–ù–µ–∞–∫—Ç–∏–≤</button>
            <button class="bg-purple-600 text-white px-2 py-1 rounded" onclick="updateStudent('${s.name}','–ê–∫—Ç–∏–≤–µ–Ω','zam').then(loadData)">–ó–∞–º</button>
            <button class="bg-red-600 text-white px-2 py-1 rounded" onclick="deleteStudent('${s.name}').then(loadData)">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        list.appendChild(li);
      });
    }

    // --- –†–µ–Ω–¥–µ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è ---
    function renderRoster(roster) {
      const list = document.getElementById('roster-list');
      list.innerHTML = '';
      Object.keys(roster).forEach(date => {
        const li = document.createElement('li');
        li.className = "bg-indigo-50 border-l-4 border-indigo-400 p-3 rounded";
        li.textContent = `${date}: ${roster[date].join(', ')}`;
        list.appendChild(li);
      });
    }

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º ---
    document.getElementById('addStudentForm').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('studentName').value;
      await addStudent(name);
      document.getElementById('studentName').value = '';
      loadData();
    });

    document.getElementById('editRosterForm').addEventListener('submit', async e => {
      e.preventDefault();
      const date = document.getElementById('rosterDate').value;
      const names = document.getElementById('rosterNames').value.split(',').map(n => n.trim());
      await saveRoster(date, names);
      document.getElementById('rosterNames').value = '';
      loadData();
    });

    // üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
      const students = await getStudents();
      renderStudents(students);

      const roster = await getRoster();
      renderRoster(roster);
    }

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadData();

    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
    window.updateStudent = updateStudent;
    window.deleteStudent = deleteStudent;
  </script>
</body>
</html>
