<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ì–ª–∞–≤–Ω–∞—è ‚Äî –°–∏—Å—Ç–µ–º–∞ –¥–µ–∂—É—Ä—Å—Ç–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .snowflake { position: fixed; top: -10px; color: white; font-size: 1.2em; animation: fall linear infinite; pointer-events: none; }
    @keyframes fall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0.7; } }
    .fade-in { animation: fadeIn 1.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    /* –†–æ–ª–∏ */
    .role { display:inline-block; padding:2px 6px; border-radius:4px; color:#fff; font-size:0.75em; margin-left:6px; }
    .starosta { background:#28a745; }
    .zam { background:#ff9800; }
    .student { background:#0078d7; }

    /* –°—Ç–∞—Ç—É—Å—ã */
    .status { font-style:italic; font-size:0.75em; padding:2px 6px; border-radius:4px; display:inline-block; margin-left:6px; }
    .status.sbejal { background:#f44336; color:#fff; }     /* –°–±–µ–∂–∞–ª */
    .status.neprishel { background:#ffeb3b; color:#000; }  /* –ù–µ –ø—Ä–∏—à—ë–ª */
    .status.active { background:#e0e0e0; color:#333; }     /* –ê–∫—Ç–∏–≤–µ–Ω/–ø—Ä–æ—á–∏–µ */

    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –∫–æ–ª–æ–Ω–∫–∏ */
    .today-col { border: 2px solid #22c55e; box-shadow: 0 0 0 2px rgba(34,197,94,0.15); }
  </style>
</head>
<body class="bg-gradient-to-r from-indigo-200 via-purple-200 to-pink-200 min-h-screen p-6 relative">

  <div id="snow"></div>

  <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-6 drop-shadow-lg fade-in">
    üåü –°–∏—Å—Ç–µ–º–∞ –¥–µ–∂—É—Ä—Å—Ç–≤ üåü
  </h1>

  <div class="flex justify-center gap-4 mb-10 fade-in">
    <button id="loginBtn" class="pulse bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-xl shadow-lg hover:scale-105 transition">
      üîë –í–æ–π—Ç–∏
    </button>
    <button id="refreshBtn" class="bg-green-600 text-white px-6 py-3 rounded-xl shadow-lg hover:scale-105 transition">
      üîÑ –û–±–Ω–æ–≤–∏—Ç—å
    </button>
  </div>

  <!-- –°–µ–≥–æ–¥–Ω—è -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8 fade-in">
    <h2 class="text-2xl font-bold text-green-600 mb-4 flex items-center gap-2">
      ‚úÖ –°–µ–≥–æ–¥–Ω—è –¥–µ–∂—É—Ä—è—Ç
    </h2>
    <ul id="today-list" class="flex flex-wrap gap-2"></ul>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ –¥–µ–∂—É—Ä–Ω—ã—Ö -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8 fade-in">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-bold text-indigo-600 flex items-center gap-2">
        üìÖ –î–µ–∂—É—Ä—Å—Ç–≤–∞ –Ω–∞ 2 –Ω–µ–¥–µ–ª–∏
      </h2>
      <span id="loadStatus" class="text-sm text-gray-500"></span>
    </div>
    <div id="roster-board" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
  <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
    <h2 class="text-2xl font-bold text-purple-600 mb-4 flex items-center gap-2">
      üë©‚Äçüéì –°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
    </h2>
    <ul id="student-list" class="space-y-2"></ul>
  </div>

  <script type="module">
    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
    document.getElementById('loginBtn').addEventListener('click', () => {
      window.location.href = "login.html";
    });

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç—Ä–æ–∫ –∏ –æ–±—ä–µ–∫—Ç–æ–≤)
    function normalizeEntry(entry) {
      if (typeof entry === 'string') {
        return { name: entry, role: 'student', status: '–ê–∫—Ç–∏–≤–µ–Ω' };
      }
      const name = entry.name ?? '–ë–µ–∑ –∏–º–µ–Ω–∏';
      const role = (entry.role ?? 'student').toLowerCase();
      // –ø—Ä–∏–≤–æ–¥–∏–º —Å—Ç–∞—Ç—É—Å –∫ –ø—Ä–∏–≤—ã—á–Ω—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º
      let status = entry.status ?? '–ê–∫—Ç–∏–≤–µ–Ω';
      const s = (status || '').toLowerCase();
      if (s.includes('—Å–±–µ–∂')) status = '–°–±–µ–∂–∞–ª';
      else if (s.includes('–Ω–µ –ø—Ä–∏—à')) status = '–ù–µ –ø—Ä–∏—à—ë–ª';
      else status = '–ê–∫—Ç–∏–≤–µ–Ω';
      return { name, role, status };
    }

    // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π fetch —Å —Ñ–æ–ª–±—ç–∫–æ–º
    async function safeFetchJSON(url, fallback) {
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      } catch (e) {
        console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', url, e);
        return fallback;
      }
    }

    async function getRoster() {
      // –û–∂–∏–¥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç: { "YYYY-MM-DD": [ {name, role, status} | "–ò–º—è" ] }
      const fallback = {};
      return await safeFetchJSON('/api/roster?ts=' + Date.now(), fallback);
    }

    async function getStudents() {
      // –û–∂–∏–¥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç: [ {name, role, status} | "–ò–º—è" ]
      const fallback = [];
      return await safeFetchJSON('/api/students?ts=' + Date.now(), fallback);
    }

    function renderToday(roster) {
      const todayList = document.getElementById('today-list');
      todayList.innerHTML = '';
      const todayDate = new Date().toISOString().split("T")[0];

      const entries = (roster[todayDate] || []).map(normalizeEntry);
      if (entries.length) {
        entries.forEach(s => {
          const li = document.createElement('li');
          li.className = "bg-green-100 border border-green-400 px-3 py-1 rounded-lg shadow-sm text-green-800 font-semibold flex items-center";
          const icon = s.role === "starosta" ? "üëë" : s.role === "zam" ? "‚≠ê" : "üéì";
          li.innerHTML = `${icon} ${s.name} <span class="role ${s.role}">${s.role}</span><span class="status ${statusClassOf(s.status)}">${s.status}</span>`;
          todayList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.className = "text-gray-600 italic";
        li.textContent = `–°–µ–≥–æ–¥–Ω—è (${todayDate}) –¥–µ–∂—É—Ä–Ω—ã—Ö –Ω–µ—Ç`;
        todayList.appendChild(li);
      }
    }

    function statusClassOf(status) {
      const s = (status || '').toLowerCase();
      if (s.includes('—Å–±–µ–∂')) return 'sbejal';
      if (s.includes('–Ω–µ –ø—Ä–∏—à')) return 'neprishel';
      return 'active';
    }

    function renderRoster(roster) {
      const board = document.getElementById('roster-board');
      board.innerHTML = '';
      const todayDate = new Date().toISOString().split("T")[0];
      const twoWeeksLater = new Date();
      twoWeeksLater.setDate(twoWeeksLater.getDate() + 14);

      let current = new Date(todayDate);
      while (current <= twoWeeksLater) {
        const dateStr = current.toISOString().split("T")[0];
        const column = document.createElement("div");
        const isToday = dateStr === todayDate;
        column.className = "border rounded-lg shadow p-3 " + (isToday ? "today-col" : "");

        const header = document.createElement("h3");
        header.className = "text-center font-bold " + (isToday ? "text-green-600" : "text-indigo-600") + " mb-2";
        header.textContent = dateStr;
        column.appendChild(header);

        const raw = roster[dateStr] || [];
        const entries = raw.map(normalizeEntry);

        if (entries.length) {
          entries.forEach(s => {
            const icon = s.role === "starosta" ? "üëë" : s.role === "zam" ? "‚≠ê" : "üéì";
            const card = document.createElement("div");
            card.className = "bg-indigo-50 p-2 mb-2 rounded shadow-sm flex items-center justify-between";
            card.innerHTML = `
              <div class="font-semibold">${icon} ${s.name}</div>
              <div>
                <span class="role ${s.role}">${s.role}</span>
                <span class="status ${statusClassOf(s.status)}">${s.status}</span>
              </div>
            `;
            column.appendChild(card);
          });
        } else {
          const card = document.createElement("div");
          card.className = "bg-gray-100 p-2 rounded text-center italic text-gray-600";
          card.textContent = "–ù–µ—Ç –¥–µ–∂—É—Ä–Ω—ã—Ö";
          column.appendChild(card);
        }

        board.appendChild(column);
        current.setDate(current.getDate() + 1);
      }
    }

    function renderStudents(students) {
      const list = document.getElementById('student-list');
      list.innerHTML = '';

      if (!students || !students.length) {
        const li = document.createElement('li');
        li.className = "text-gray-600 italic";
        li.textContent = "–°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø—É—Å—Ç";
        list.appendChild(li);
        return;
      }

      students.map(normalizeEntry).forEach(s => {
        const icon = s.role === "starosta" ? "üëë" : s.role === "zam" ? "‚≠ê" : "üéì";
        const li = document.createElement('li');
        li.className = "bg-purple-50 border-l-4 border-purple-400 p-3 rounded shadow-sm flex justify-between hover:bg-purple-100 transition";
        li.innerHTML = `
          <span class="font-semibold">${icon} ${s.name}</span>
          <span>
            <span class="role ${s.role}">${s.role}</span>
            <span class="status ${statusClassOf(s.status)}">${s.status}</span>
          </span>
        `;
        list.appendChild(li);
      });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∏ –∑–∞—â–∏—Ç–æ–π –∫–Ω–æ–ø–∫–∏
    async function loadData() {
      const loadStatus = document.getElementById('refreshBtn');
      const statusText = document.getElementById('loadStatus');
      loadStatus.disabled = true;
      loadStatus.classList.add('opacity-60', 'cursor-not-allowed');
      statusText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

      const roster = await getRoster();
      renderToday(roster);
      renderRoster(roster);

      const students = await getStudents();
      renderStudents(students);

      statusText.textContent = '–ì–æ—Ç–æ–≤–æ';
      setTimeout(() => { statusText.textContent = ''; }, 1500);
      loadStatus.disabled = false;
      loadStatus.classList.remove('opacity-60', 'cursor-not-allowed');
    }

    // –°–æ–±—ã—Ç–∏—è
    loadData();
    document.getElementById("refreshBtn").addEventListener("click", loadData);

    // –°–Ω–µ–≥
    function createSnowflakes() {
      const snowContainer = document.getElementById('snow');
      for (let i = 0; i < 30; i++) {
        const snowflake = document.createElement('div');
        snowflake.className = 'snowflake';
        snowflake.textContent = '‚ùÑ';
        snowflake.style.left = Math.random() * 100 + 'vw';
        snowflake.style.animationDuration = (5 + Math.random() * 5) + 's';
        snowflake.style.fontSize = (10 + Math.random() * 20) + 'px';
        snowContainer.appendChild(snowflake);
      }
    }
    createSnowflakes();
  </script>
</body>
</html>

