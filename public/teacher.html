<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–£—á–∏—Ç–µ–ª—å ‚Äî –°–∏—Å—Ç–µ–º–∞ –¥–µ–∂—É—Ä—Å—Ç–≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-green-200 via-blue-200 to-indigo-200 min-h-screen p-6">

  <h1 class="text-3xl font-bold text-center text-indigo-700 mb-8">üìã –°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h1>

  <div id="students" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"></div>

  <div class="mt-8 text-center">
    <button id="sendTelegram" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">
      üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
    </button>
  </div>

  <script>
    let studentsData = [];

    async function loadStudents() {
      const res = await fetch("/api/students");
      const students = await res.json();
      studentsData = students;

      const container = document.getElementById("students");
      container.innerHTML = "";

      students.forEach(s => {
        const card = document.createElement("div");
        card.className = "p-4 bg-white rounded-xl shadow flex flex-col gap-2";

        const name = document.createElement("h2");
        name.className = "font-bold text-lg text-indigo-700";
        name.textContent = s.name;

        const select = document.createElement("select");
        select.className = "border rounded p-2";
        ["–ü—Ä–∏—à—ë–ª", "–û–ø–æ–∑–¥–∞–ª", "–ù–µ –ø—Ä–∏—à—ë–ª"].forEach(opt => {
          const option = document.createElement("option");
          option.value = opt;
          option.textContent = opt;
          select.appendChild(option);
        });

        const badge = document.createElement("span");
        badge.className = "inline-block px-3 py-1 rounded text-white text-sm bg-green-500";
        badge.textContent = "–ü—Ä–∏—à—ë–ª";

        select.addEventListener("change", () => {
          if (select.value === "–ü—Ä–∏—à—ë–ª") {
            badge.textContent = "–ü—Ä–∏—à—ë–ª";
            badge.className = "inline-block px-3 py-1 rounded text-white text-sm bg-green-500";
          } else if (select.value === "–û–ø–æ–∑–¥–∞–ª") {
            badge.textContent = "–û–ø–æ–∑–¥–∞–ª";
            badge.className = "inline-block px-3 py-1 rounded text-white text-sm bg-yellow-500";
          } else {
            badge.textContent = "–ù–µ –ø—Ä–∏—à—ë–ª";
            badge.className = "inline-block px-3 py-1 rounded text-white text-sm bg-red-500";
          }
          // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –º–∞—Å—Å–∏–≤–µ
          const student = studentsData.find(st => st.name === s.name);
          if (student) student.status = select.value;
        });

        card.appendChild(name);
        card.appendChild(select);
        card.appendChild(badge);
        container.appendChild(card);
      });
    }

    // üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
    document.getElementById("sendTelegram").addEventListener("click", async () => {
      const today = new Date().toLocaleDateString("ru-RU");
      let message = `üìÖ –û—Ç—á—ë—Ç –∑–∞ ${today}\n\n`;

      studentsData.forEach(s => {
        message += `${s.name} ‚Äî ${s.status || "–ü—Ä–∏—à—ë–ª"}\n`;
      });

      // ‚ö° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –≤ Telegram
      await fetch("/api/sendTelegram", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: message })
      });

      alert("–û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram ‚úÖ");
    });

    loadStudents();
  </script>
</body>
</html>
